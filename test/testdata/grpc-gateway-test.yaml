apiVersion: gateway.avapigw.io/v1
kind: Gateway
metadata:
  name: grpc-test-gateway
  labels:
    app: avapigw
    environment: test
spec:
  listeners:
    - name: grpc
      port: 19000
      protocol: GRPC
      bind: 0.0.0.0
      grpc:
        maxConcurrentStreams: 100
        maxRecvMsgSize: 4194304
        maxSendMsgSize: 4194304
        reflection: true
        healthCheck: true
        keepalive:
          time: 30s
          timeout: 10s
          permitWithoutStream: false
          maxConnectionIdle: 5m
          maxConnectionAge: 30m
          maxConnectionAgeGrace: 5s

  grpcRoutes:
    - name: test-service
      match:
        - service:
            exact: "api.v1.TestService"
      route:
        - destination:
            host: 127.0.0.1
            port: 8803
          weight: 50
        - destination:
            host: 127.0.0.1
            port: 8804
          weight: 50
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: "unavailable,resource-exhausted"

    - name: test-service-unary
      match:
        - service:
            exact: "api.v1.TestService"
          method:
            exact: "Unary"
      route:
        - destination:
            host: 127.0.0.1
            port: 8803
          weight: 100
      timeout: 10s

    - name: test-service-stream
      match:
        - service:
            exact: "api.v1.TestService"
          method:
            prefix: "Server"
      route:
        - destination:
            host: 127.0.0.1
            port: 8803
          weight: 100
      timeout: 60s

    - name: health-service
      match:
        - service:
            exact: "grpc.health.v1.Health"
      route:
        - destination:
            host: 127.0.0.1
            port: 8803
          weight: 100

    - name: catch-all-grpc
      match:
        - service:
            prefix: ""
      route:
        - destination:
            host: 127.0.0.1
            port: 8803
          weight: 50
        - destination:
            host: 127.0.0.1
            port: 8804
          weight: 50

  grpcBackends:
    - name: grpc-backend-1
      hosts:
        - address: 127.0.0.1
          port: 8803
          weight: 1
      healthCheck:
        enabled: true
        service: ""
        interval: 5s
        timeout: 3s
        healthyThreshold: 2
        unhealthyThreshold: 3
      loadBalancer:
        algorithm: roundRobin

    - name: grpc-backend-2
      hosts:
        - address: 127.0.0.1
          port: 8804
          weight: 1
      healthCheck:
        enabled: true
        service: ""
        interval: 5s
        timeout: 3s
        healthyThreshold: 2
        unhealthyThreshold: 3
      loadBalancer:
        algorithm: roundRobin

  rateLimit:
    enabled: true
    requestsPerSecond: 100
    burst: 200
    perClient: true

  circuitBreaker:
    enabled: true
    threshold: 5
    timeout: 30s
    halfOpenRequests: 3

  observability:
    metrics:
      enabled: true
      path: /metrics
    logging:
      level: debug
      format: json
