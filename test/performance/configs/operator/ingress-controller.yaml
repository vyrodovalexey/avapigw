# Yandex Tank Configuration: Ingress Controller Performance Test
# Purpose: Measure gateway performance when processing Kubernetes Ingress resources
# Duration: 5 minutes total (1m warmup + 3m sustain + 1m cooldown)
# Target: Gateway with Ingress-configured routes
#
# Scenario: As Ingress Controller
# - Routes are configured via standard Kubernetes Ingress resources
# - Operator watches Ingress resources with ingressClassName: avapigw
# - Converts Ingress to internal routes and pushes to gateway via gRPC
# - This test measures end-to-end performance with Ingress-based configuration

# Test metadata
name: ingress-controller
description: Gateway performance as Kubernetes Ingress controller

phantom:
  package: yandextank.plugins.Phantom
  enabled: true
  address: host.docker.internal:8080
  load_profile:
    load_type: rps
    # Warmup: 1 min ramp from 100 to 1500 RPS
    # Sustain: 3 min at 1500 RPS (main measurement phase)
    # Cooldown: 1 min ramp down
    schedule: line(100, 1500, 1m) const(1500, 3m) line(1500, 100, 1m)

  ammofile: /var/loadtest/ammo/ingress-routes.txt
  ammo_type: uri

  # Connection settings
  connection_test: true
  writelog: "0"
  ssl: false
  timeout: 10s

  # Instance settings - moderate concurrency for Ingress testing
  instances: 1500
  threads: 8

  # HTTP settings
  header_http: "1.1"
  headers:
    - "[Host: api.example.com]"
    - "[User-Agent: YandexTank/IngressPerftest]"
    - "[Accept: application/json]"
    - "[Connection: keep-alive]"
    - "[X-Perf-Test: ingress-controller]"

console:
  package: yandextank.plugins.Console
  enabled: true
  short_only: false

telegraf:
  package: yandextank.plugins.Telegraf
  enabled: true
  config: |
    [global_tags]
      test = "ingress-controller"
    
    [agent]
      interval = "1s"
      round_interval = true
      metric_batch_size = 1000
      metric_buffer_limit = 10000
      collection_jitter = "0s"
      flush_interval = "1s"
      flush_jitter = "0s"
    
    [[inputs.cpu]]
      percpu = true
      totalcpu = true
    
    [[inputs.mem]]
    
    [[inputs.net]]
    
    [[inputs.netstat]]

autostop:
  package: yandextank.plugins.Autostop
  enabled: true
  autostop:
    # Stop if HTTP 5xx errors exceed 5% for 30 seconds
    - http(5xx,5%,30s)
    # Stop if 50% of requests exceed 2000ms for 30 seconds
    - time(2000,50%,30s)
    # Stop if total network errors exceed 5% for 30 seconds
    - http(net,5%,30s)

# Performance targets for Ingress-configured gateway:
# - P99 latency: < 100ms
# - Throughput: > 1500 RPS
# - Error rate: < 0.1%
# - Ingress conversion latency: < 30us (basic), < 50us (complex)
