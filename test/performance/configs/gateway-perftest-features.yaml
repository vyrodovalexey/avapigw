# Gateway configuration for performance testing new features
# This configuration includes:
# - Route-level request limits
# - Route-level CORS configuration
# - Route-level security headers
# - Backend circuit breaker
# - Backend JWT authentication
# - Backend Basic authentication

apiVersion: gateway.avapigw.io/v1
kind: Gateway
metadata:
  name: perftest-features-gateway
  labels:
    app: avapigw
    environment: perftest
spec:
  listeners:
    - name: http
      port: 8080
      protocol: HTTP
      hosts:
        - "*"
      bind: 0.0.0.0

  routes:
    # Health check endpoint - direct response (no backend)
    - name: health-check
      match:
        - uri:
            exact: /health
          methods:
            - GET
      directResponse:
        status: 200
        body: '{"status":"healthy","gateway":"perftest-features"}'
        headers:
          Content-Type: application/json

    # ============================================
    # Route-Level Request Limits Testing
    # ============================================

    # Route with small body limit (1MB)
    - name: small-body-limit-route
      match:
        - uri:
            prefix: /api/v1/small
          methods:
            - GET
            - POST
            - PUT
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
      requestLimits:
        maxBodySize: 1048576  # 1MB
        maxHeaderSize: 524288  # 512KB
      timeout: 10s

    # Route with large body limit (50MB)
    - name: large-body-limit-route
      match:
        - uri:
            prefix: /api/v1/large
          methods:
            - GET
            - POST
            - PUT
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
      requestLimits:
        maxBodySize: 52428800  # 50MB
        maxHeaderSize: 2097152  # 2MB
      timeout: 30s

    # Route with default limits (inherits global)
    - name: default-limit-route
      match:
        - uri:
            prefix: /api/v1/default
          methods:
            - GET
            - POST
            - PUT
            - DELETE
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
      timeout: 10s

    # ============================================
    # Route-Level CORS Testing
    # ============================================

    # Route with custom CORS configuration
    - name: custom-cors-route
      match:
        - uri:
            prefix: /api/v1/cors
          methods:
            - GET
            - POST
            - OPTIONS
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
      cors:
        allowOrigins:
          - "https://example.com"
          - "https://app.example.com"
        allowMethods:
          - GET
          - POST
        allowHeaders:
          - Content-Type
          - X-Custom-Header
        exposeHeaders:
          - X-Response-ID
        maxAge: 3600
        allowCredentials: true
      timeout: 10s

    # Route with full custom configuration
    - name: full-custom-route
      match:
        - uri:
            prefix: /api/v1/custom
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
      requestLimits:
        maxBodySize: 5242880  # 5MB
        maxHeaderSize: 1048576  # 1MB
      cors:
        allowOrigins:
          - "https://custom.example.com"
        allowMethods:
          - GET
          - POST
          - PUT
          - DELETE
        allowHeaders:
          - Content-Type
          - Authorization
          - X-Request-ID
        exposeHeaders:
          - X-Request-ID
          - X-Response-Time
        maxAge: 7200
        allowCredentials: false
      security:
        enabled: true
        referrerPolicy: "no-referrer"
        headers:
          enabled: true
          xFrameOptions: "SAMEORIGIN"
          xContentTypeOptions: "nosniff"
      timeout: 10s

    # Route with security headers
    - name: secure-route
      match:
        - uri:
            prefix: /api/v1/secure
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
      security:
        enabled: true
        referrerPolicy: "strict-origin-when-cross-origin"
        headers:
          enabled: true
          xFrameOptions: "DENY"
          xContentTypeOptions: "nosniff"
          xXSSProtection: "1; mode=block"
          customHeaders:
            X-Custom-Security: "enabled"
      timeout: 10s

    # ============================================
    # Backend Circuit Breaker Testing
    # ============================================

    # Route to backend with circuit breaker
    - name: circuit-breaker-route
      match:
        - uri:
            prefix: /api/v1/cb
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
          weight: 50
        - destination:
            host: 127.0.0.1
            port: 8802
          weight: 50
      timeout: 15s
      retries:
        attempts: 2
        perTryTimeout: 5s
        retryOn: "5xx,reset,connect-failure"

    # ============================================
    # Backend JWT Authentication Testing
    # ============================================

    # Route to backend with static JWT token
    - name: jwt-static-route
      match:
        - uri:
            prefix: /api/v1/jwt-static
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
            # Uses backend-with-jwt-static
      timeout: 15s

    # Route to backend with OIDC JWT token
    - name: jwt-oidc-route
      match:
        - uri:
            prefix: /api/v1/jwt-oidc
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
            # Uses backend-with-jwt-oidc
      timeout: 15s

    # Route to backend with custom JWT header
    - name: jwt-custom-route
      match:
        - uri:
            prefix: /api/v1/jwt-custom
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
            # Uses backend-with-custom-header
      timeout: 15s

    # ============================================
    # Backend Basic Authentication Testing
    # ============================================

    # Route to backend with static Basic auth
    - name: basic-static-route
      match:
        - uri:
            prefix: /api/v1/basic-static
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
            # Uses backend-with-basic-static
      timeout: 15s

    # Route to backend with Vault Basic auth
    - name: basic-vault-route
      match:
        - uri:
            prefix: /api/v1/basic-vault
          methods:
            - GET
            - POST
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
            # Uses backend-with-basic-vault
      timeout: 15s

    # ============================================
    # Standard Routes
    # ============================================

    # Items API with load balancing
    - name: items-api
      match:
        - uri:
            prefix: /api/v1/items
          methods:
            - GET
            - POST
            - PUT
            - DELETE
      route:
        - destination:
            host: 127.0.0.1
            port: 8801
          weight: 50
        - destination:
            host: 127.0.0.1
            port: 8802
          weight: 50
      timeout: 30s

    # Catch-all route
    - name: catch-all
      match:
        - uri:
            prefix: /
      route:
        - destination:
            host: 127.0.0.1
            port: 8801

  backends:
    # Standard backend
    - name: backend-service-1
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      healthCheck:
        path: /health
        interval: 5s
        timeout: 3s
        healthyThreshold: 2
        unhealthyThreshold: 3
      loadBalancer:
        algorithm: roundRobin
      connectionPool:
        maxConnections: 1000
        maxPendingRequests: 1000
        maxRequestsPerConnection: 0
        connectTimeout: 5s

    # Backend with circuit breaker
    - name: backend-with-cb
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      healthCheck:
        path: /health
        interval: 5s
        timeout: 3s
        healthyThreshold: 2
        unhealthyThreshold: 3
      loadBalancer:
        algorithm: roundRobin
      circuitBreaker:
        enabled: true
        threshold: 5
        timeout: 30s
        halfOpenRequests: 3
      connectionPool:
        maxConnections: 500
        maxPendingRequests: 500
        connectTimeout: 5s

    # Backend with aggressive circuit breaker
    - name: backend-with-aggressive-cb
      hosts:
        - address: 127.0.0.1
          port: 8802
          weight: 1
      healthCheck:
        path: /health
        interval: 5s
        timeout: 3s
        healthyThreshold: 2
        unhealthyThreshold: 3
      loadBalancer:
        algorithm: roundRobin
      circuitBreaker:
        enabled: true
        threshold: 3
        timeout: 10s
        halfOpenRequests: 1
      connectionPool:
        maxConnections: 500
        maxPendingRequests: 500
        connectTimeout: 5s

    # Backend with static JWT authentication
    - name: backend-with-jwt-static
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      authentication:
        type: jwt
        jwt:
          enabled: true
          tokenSource: static
          staticToken: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkJhY2tlbmQgU2VydmljZSIsImlhdCI6MTUxNjIzOTAyMn0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
          headerName: "Authorization"
          headerPrefix: "Bearer"

    # Backend with OIDC JWT authentication
    - name: backend-with-jwt-oidc
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      authentication:
        type: jwt
        jwt:
          enabled: true
          tokenSource: oidc
          oidc:
            issuerUrl: "http://127.0.0.1:8090/realms/gateway-test"
            clientId: "gateway"
            clientSecret: "gateway-secret"
            scopes:
              - openid
            tokenCacheTTL: 5m

    # Backend with custom JWT header
    - name: backend-with-custom-header
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      authentication:
        type: jwt
        jwt:
          enabled: true
          tokenSource: static
          staticToken: "custom-token-value"
          headerName: "X-Backend-Auth"
          headerPrefix: "Token"

    # Backend with static Basic authentication
    - name: backend-with-basic-static
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      authentication:
        type: basic
        basic:
          enabled: true
          username: "backend-user"
          password: "backend-pass"

    # Backend with Vault Basic authentication
    - name: backend-with-basic-vault
      hosts:
        - address: 127.0.0.1
          port: 8801
          weight: 1
      authentication:
        type: basic
        basic:
          enabled: true
          vaultPath: "secret/data/backend-auth/basic-creds"
          usernameKey: "username"
          passwordKey: "password"

  # Global request limits
  requestLimits:
    maxBodySize: 10485760  # 10MB
    maxHeaderSize: 1048576  # 1MB

  # Global CORS configuration
  cors:
    allowOrigins:
      - "*"
    allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - OPTIONS
    allowHeaders:
      - Content-Type
      - Authorization
      - X-Request-ID
    exposeHeaders:
      - X-Request-ID
    maxAge: 86400
    allowCredentials: false

  # Global security configuration
  security:
    enabled: true
    referrerPolicy: "strict-origin"
    headers:
      enabled: true
      xFrameOptions: "SAMEORIGIN"
      xContentTypeOptions: "nosniff"
      xXSSProtection: "1; mode=block"

  # Global circuit breaker
  circuitBreaker:
    enabled: true
    threshold: 10
    timeout: 60s
    halfOpenRequests: 5

  # Rate limiting
  rateLimit:
    enabled: true
    requestsPerSecond: 2000
    burst: 4000
    perClient: true

  # Vault configuration for credential fetching
  vault:
    enabled: true
    address: "http://127.0.0.1:8200"
    token: "myroot"
    kvMount: "secret"

  observability:
    metrics:
      enabled: true
      path: /metrics
      port: 9090
    tracing:
      enabled: false
      samplingRate: 0.01
    logging:
      level: warn
      format: json
