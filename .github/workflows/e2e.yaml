name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      cluster_type:
        description: 'Cluster type (kind or existing)'
        required: true
        default: 'kind'
        type: choice
        options:
          - kind
          - existing
      image_tag:
        description: 'Image tag to test'
        required: false
        default: 'latest'
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main]
    paths:
      - 'test/e2e/**'
      - '.github/workflows/e2e.yaml'

env:
  GO_VERSION: '1.24'
  REGISTRY: docker.io
  IMAGE_NAME_GATEWAY: vyrodovalexey/avapigw-gateway
  IMAGE_NAME_OPERATOR: vyrodovalexey/avapigw-operator
  HELM_RELEASE_NAME: avapigw
  HELM_NAMESPACE: avapigw-e2e

jobs:
  setup-cluster:
    name: Setup Test Cluster
    runs-on: ubuntu-latest
    outputs:
      cluster_ready: ${{ steps.cluster.outputs.ready }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Create kind cluster
        if: github.event.inputs.cluster_type != 'existing'
        uses: helm/kind-action@v1
        with:
          cluster_name: avapigw-e2e
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
              - role: control-plane
              - role: worker
              - role: worker

      - name: Verify cluster
        id: cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          echo "ready=true" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [setup-cluster]
    if: needs.setup-cluster.outputs.cluster_ready == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Create kind cluster
        if: github.event.inputs.cluster_type != 'existing'
        uses: helm/kind-action@v1
        with:
          cluster_name: avapigw-e2e

      - name: Install CRDs
        run: kubectl apply -f config/crd/bases/

      - name: Create namespace
        run: kubectl create namespace ${{ env.HELM_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install ${{ env.HELM_RELEASE_NAME }} deployment/helm/avapigw \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --set operator.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_OPERATOR }} \
            --set operator.image.tag=${{ steps.image-tag.outputs.tag }} \
            --set gateway.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_GATEWAY }} \
            --set gateway.image.tag=${{ steps.image-tag.outputs.tag }} \
            --set crds.install=false \
            --set webhook.selfSignedCert=true \
            --wait --timeout 10m

      - name: Wait for pods to be ready
        run: |
          echo "Waiting for operator pods..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=operator -n ${{ env.HELM_NAMESPACE }} --timeout=300s || true
          
          echo "Waiting for gateway pods..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=gateway -n ${{ env.HELM_NAMESPACE }} --timeout=300s || true
          
          echo "Current pod status:"
          kubectl get pods -n ${{ env.HELM_NAMESPACE }}

      - name: Show deployment status
        run: |
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.HELM_NAMESPACE }} -o wide
          
          echo "=== Services ==="
          kubectl get svc -n ${{ env.HELM_NAMESPACE }}
          
          echo "=== Events ==="
          kubectl get events -n ${{ env.HELM_NAMESPACE }} --sort-by='.lastTimestamp' | tail -20

  run-e2e:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Create kind cluster
        if: github.event.inputs.cluster_type != 'existing'
        uses: helm/kind-action@v1
        with:
          cluster_name: avapigw-e2e

      - name: Install Ginkgo
        run: go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Run E2E tests
        run: |
          export KUBECONFIG="${HOME}/.kube/config"
          export E2E_NAMESPACE="${{ env.HELM_NAMESPACE }}"
          
          # Run E2E tests
          ginkgo -v -tags=e2e ./test/e2e/... || true
        env:
          E2E_GATEWAY_SERVICE: avapigw-gateway
          E2E_OPERATOR_SERVICE: avapigw-operator

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Operator Logs ==="
          kubectl logs -l app.kubernetes.io/component=operator -n ${{ env.HELM_NAMESPACE }} --tail=100 || true
          
          echo "=== Gateway Logs ==="
          kubectl logs -l app.kubernetes.io/component=gateway -n ${{ env.HELM_NAMESPACE }} --tail=100 || true
          
          echo "=== Describe Pods ==="
          kubectl describe pods -n ${{ env.HELM_NAMESPACE }} || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            test/e2e/*.xml
            test/e2e/*.log
          retention-days: 7

  functional-tests:
    name: Run Functional Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Create kind cluster
        if: github.event.inputs.cluster_type != 'existing'
        uses: helm/kind-action@v1
        with:
          cluster_name: avapigw-e2e

      - name: Run functional tests
        run: |
          export KUBECONFIG="${HOME}/.kube/config"
          export FUNCTIONAL_NAMESPACE="${{ env.HELM_NAMESPACE }}"
          
          go test -v -tags=functional ./test/functional/... || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: functional-test-results
          path: |
            test/functional/*.xml
            test/functional/*.log
          retention-days: 7

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [run-e2e, functional-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Create kind cluster
        if: github.event.inputs.cluster_type != 'existing'
        uses: helm/kind-action@v1
        with:
          cluster_name: avapigw-e2e

      - name: Uninstall Helm release
        run: |
          helm uninstall ${{ env.HELM_RELEASE_NAME }} --namespace ${{ env.HELM_NAMESPACE }} || true

      - name: Delete namespace
        run: |
          kubectl delete namespace ${{ env.HELM_NAMESPACE }} --ignore-not-found=true

      - name: Delete CRDs
        run: |
          kubectl delete -f config/crd/bases/ --ignore-not-found=true

      - name: Delete kind cluster
        if: github.event.inputs.cluster_type != 'existing'
        run: |
          kind delete cluster --name avapigw-e2e || true
