# Sample Backend resource
# This Backend defines a backend service with load balancing, health checking,
# and connection pooling configuration
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: Backend
metadata:
  name: sample-backend
  namespace: default
  labels:
    app: api-gateway
spec:
  # Option 1: Reference a Kubernetes Service
  service:
    name: my-service
    namespace: default
    port: 8080

  # Load balancing configuration
  loadBalancing:
    algorithm: RoundRobin
    # For ConsistentHash algorithm:
    # algorithm: ConsistentHash
    # consistentHash:
    #   type: Header
    #   header: X-User-ID
    #   minimumRingSize: 1024

  # Health check configuration
  healthCheck:
    enabled: true
    interval: "10s"
    timeout: "5s"
    healthyThreshold: 2
    unhealthyThreshold: 3
    http:
      path: "/health"
      method: GET
      expectedStatuses:
        - 200
        - 204

  # Connection pool configuration
  connectionPool:
    http:
      maxConnections: 100
      maxPendingRequests: 100
      maxRequestsPerConnection: 0
      idleTimeout: "60s"
      h2UpgradePolicy: DO_NOT_UPGRADE
    tcp:
      maxConnections: 100
      connectTimeout: "10s"
      tcpKeepalive:
        probes: 3
        time: "60s"
        interval: "10s"

  # Circuit breaker configuration
  circuitBreaker:
    enabled: true
    consecutiveErrors: 5
    interval: "30s"
    baseEjectionTime: "30s"
    maxEjectionPercent: 50

  # Outlier detection configuration
  outlierDetection:
    enabled: true
    consecutive5xxErrors: 5
    consecutiveGatewayErrors: 5
    interval: "10s"
    baseEjectionTime: "30s"
    maxEjectionPercent: 10

  # TLS configuration for backend connections
  tls:
    mode: Simple
    insecureSkipVerify: false
    # For mutual TLS:
    # mode: Mutual
    # certificateRef:
    #   name: client-cert-secret
    # caCertificateRef:
    #   name: ca-cert-secret
    # sni: backend.internal

---
# Backend with direct endpoints (no Kubernetes Service)
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: Backend
metadata:
  name: external-backend
  namespace: default
  labels:
    app: api-gateway
spec:
  # Direct endpoint configuration
  endpoints:
    - address: "10.0.0.1"
      port: 8080
      weight: 50
    - address: "10.0.0.2"
      port: 8080
      weight: 50
    - address: "external-service.example.com"
      port: 443
      weight: 100

  loadBalancing:
    algorithm: LeastConnections

  healthCheck:
    enabled: true
    interval: "15s"
    timeout: "10s"
    tcp:
      send: "PING"
      receive: "PONG"

  tls:
    mode: Simple
    sni: "external-service.example.com"

---
# Backend with gRPC health check
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: Backend
metadata:
  name: grpc-backend
  namespace: default
spec:
  service:
    name: grpc-service
    port: 9090

  healthCheck:
    enabled: true
    interval: "10s"
    timeout: "5s"
    grpc:
      service: "grpc.health.v1.Health"

  loadBalancing:
    algorithm: ConsistentHash
    consistentHash:
      type: Header
      header: x-session-id
      minimumRingSize: 2048
