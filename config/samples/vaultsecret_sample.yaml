# Sample VaultSecret resource
# This VaultSecret defines a reference to a secret stored in HashiCorp Vault
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: VaultSecret
metadata:
  name: sample-vaultsecret
  namespace: default
  labels:
    app: api-gateway
spec:
  # Vault connection configuration
  vaultConnection:
    address: "https://vault.example.com:8200"
    namespace: "admin"  # Vault Enterprise namespace
    auth:
      # Kubernetes authentication (recommended for K8s workloads)
      kubernetes:
        role: "api-gateway"
        mountPath: "kubernetes"
        # Optional: Use a specific service account
        # serviceAccountRef:
        #   name: vault-auth-sa
    tls:
      insecureSkipVerify: false
      # Optional: Custom CA certificate
      # caCertRef:
      #   name: vault-ca-cert

  # Path to the secret in Vault
  path: "api-gateway/database/credentials"
  mountPoint: "secret"

  # Key mappings from Vault to target secret
  keys:
    - vaultKey: username
      targetKey: DB_USERNAME
    - vaultKey: password
      targetKey: DB_PASSWORD
      encoding: None
    - vaultKey: connection_string
      targetKey: DB_CONNECTION_STRING

  # Refresh configuration
  refresh:
    enabled: true
    interval: "5m"
    jitterPercent: 10

  # Target Kubernetes secret configuration
  target:
    name: database-credentials
    namespace: default
    type: Opaque
    labels:
      app: api-gateway
      managed-by: vault-secret-operator
    annotations:
      description: "Database credentials synced from Vault"
    creationPolicy: Owner
    deletionPolicy: Delete

---
# VaultSecret with AppRole authentication
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: VaultSecret
metadata:
  name: approle-vaultsecret
  namespace: default
spec:
  vaultConnection:
    address: "https://vault.example.com:8200"
    auth:
      appRole:
        roleId: "api-gateway-role-id"
        secretIdRef:
          name: vault-approle-secret
        secretIdKey: secret-id
        mountPath: "approle"

  path: "api-gateway/tls/certificates"
  mountPoint: "secret"

  keys:
    - vaultKey: tls.crt
      targetKey: tls.crt
    - vaultKey: tls.key
      targetKey: tls.key
    - vaultKey: ca.crt
      targetKey: ca.crt

  target:
    name: gateway-tls-secret
    type: kubernetes.io/tls
    creationPolicy: Owner

---
# VaultSecret with token authentication (for development/testing)
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: VaultSecret
metadata:
  name: token-vaultsecret
  namespace: default
spec:
  vaultConnection:
    address: "http://vault.vault.svc.cluster.local:8200"
    inCluster: true
    auth:
      token:
        secretRef:
          name: vault-token
        tokenKey: token

  path: "api-gateway/config/api-keys"
  mountPoint: "kv"

  keys:
    - vaultKey: api_key_1
      targetKey: API_KEY_1
    - vaultKey: api_key_2
      targetKey: API_KEY_2

  refresh:
    enabled: true
    interval: "1m"

  target:
    name: api-keys
    creationPolicy: Merge
    deletionPolicy: Retain

---
# VaultSecret for Docker registry credentials
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: VaultSecret
metadata:
  name: docker-registry-secret
  namespace: default
spec:
  vaultConnection:
    address: "https://vault.example.com:8200"
    auth:
      kubernetes:
        role: "api-gateway"

  path: "api-gateway/docker/registry"
  mountPoint: "secret"

  keys:
    - vaultKey: dockerconfigjson
      targetKey: .dockerconfigjson
      encoding: Base64

  target:
    name: docker-registry-credentials
    type: kubernetes.io/dockerconfigjson
    creationPolicy: Owner
    deletionPolicy: Delete
