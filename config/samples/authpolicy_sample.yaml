# Sample AuthPolicy resource
# This AuthPolicy defines authentication and authorization configuration
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: AuthPolicy
metadata:
  name: sample-authpolicy
  namespace: default
  labels:
    app: api-gateway
spec:
  # Target resource to apply authentication to
  targetRef:
    group: avapigw.vyrodovalexey.github.com
    kind: HTTPRoute
    name: sample-httproute

  # Authentication configuration
  authentication:
    # JWT authentication
    jwt:
      enabled: true
      issuer: "https://auth.example.com"
      audiences:
        - "api.example.com"
        - "https://api.example.com"
      jwksUri: "https://auth.example.com/.well-known/jwks.json"
      jwksCacheDuration: "1h"
      tokenLocation:
        header: Authorization
        prefix: "Bearer "
      claimsToHeaders:
        - claim: sub
          header: X-User-ID
        - claim: email
          header: X-User-Email
        - claim: roles
          header: X-User-Roles
      requiredClaims:
        - name: iss
          values:
            - "https://auth.example.com"
        - name: aud
          values:
            - "api.example.com"
      forwardOriginalToken: true

    # API Key authentication (alternative to JWT)
    # apiKey:
    #   enabled: true
    #   location:
    #     header: X-API-Key
    #   validation:
    #     type: Secret
    #     secretRef:
    #       name: api-keys-secret

  # Authorization configuration
  authorization:
    defaultAction: DENY
    rules:
      # Rule 1: Allow admin users full access
      - name: admin-access
        when:
          - claim: roles
            values:
              - admin
              - superadmin
        action: ALLOW

      # Rule 2: Allow users to access their own resources
      - name: user-own-resources
        when:
          - claim: sub
            matchPath: "/users/{userId}/*"
        to:
          - operation:
              methods:
                - GET
                - PUT
                - PATCH
              paths:
                - "/users/*"
        action: ALLOW

      # Rule 3: Allow read access to public endpoints
      - name: public-read
        to:
          - operation:
              methods:
                - GET
              paths:
                - "/public/*"
                - "/health"
                - "/ready"
        action: ALLOW

      # Rule 4: Allow internal services
      - name: internal-services
        when:
          - sourceIP:
              cidrs:
                - "10.0.0.0/8"
                - "172.16.0.0/12"
        action: ALLOW

      # Rule 5: Deny access from blocked IPs
      - name: block-suspicious
        when:
          - sourceIP:
              cidrs:
                - "192.168.100.0/24"
        action: DENY

  # Security headers configuration
  securityHeaders:
    # CORS configuration
    cors:
      enabled: true
      allowOrigins:
        - exact: "https://app.example.com"
        - prefix: "https://*.example.com"
        - regex: "https://.*\\.trusted\\.com"
      allowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-Request-ID
        - X-API-Key
      exposeHeaders:
        - X-Request-ID
        - X-RateLimit-Remaining
      maxAge: "86400s"
      allowCredentials: true

    # HSTS configuration
    hsts:
      enabled: true
      maxAge: 31536000
      includeSubDomains: true
      preload: true

    # Other security headers
    contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
    xFrameOptions: DENY
    xContentTypeOptions: nosniff
    xXSSProtection: "1; mode=block"
    referrerPolicy: strict-origin-when-cross-origin
    permissionsPolicy: "geolocation=(), microphone=(), camera=()"

---
# Simple API Key authentication policy
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: AuthPolicy
metadata:
  name: apikey-auth
  namespace: default
spec:
  targetRef:
    group: avapigw.vyrodovalexey.github.com
    kind: HTTPRoute
    name: api-route

  authentication:
    apiKey:
      enabled: true
      location:
        header: X-API-Key
        queryParam: api_key
      validation:
        type: Secret
        secretRef:
          name: api-keys

  authorization:
    defaultAction: ALLOW

---
# Basic authentication policy
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: AuthPolicy
metadata:
  name: basic-auth
  namespace: default
spec:
  targetRef:
    group: avapigw.vyrodovalexey.github.com
    kind: HTTPRoute
    name: admin-route

  authentication:
    basic:
      enabled: true
      secretRef:
        name: basic-auth-credentials
      realm: "Admin Area"

  authorization:
    defaultAction: ALLOW
