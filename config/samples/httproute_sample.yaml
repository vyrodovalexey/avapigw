# Sample HTTPRoute resource
# This HTTPRoute defines routing rules for HTTP traffic
apiVersion: avapigw.vyrodovalexey.github.com/v1alpha1
kind: HTTPRoute
metadata:
  name: sample-httproute
  namespace: default
  labels:
    app: api-gateway
spec:
  # Reference to the parent Gateway
  parentRefs:
    - name: sample-gateway
      sectionName: http

  # Hostnames to match
  hostnames:
    - "api.example.com"
    - "www.example.com"

  # Routing rules
  rules:
    # Rule 1: Route /api/v1/* to backend-v1
    - matches:
        - path:
            type: PathPrefix
            value: "/api/v1"
          method: GET
        - path:
            type: PathPrefix
            value: "/api/v1"
          method: POST
      filters:
        # Add request headers
        - type: RequestHeaderModifier
          requestHeaderModifier:
            add:
              - name: X-Request-ID
                value: "${request_id}"
            set:
              - name: X-Forwarded-Proto
                value: "https"
      backendRefs:
        - name: backend-v1
          port: 8080
          weight: 100
      timeouts:
        request: "30s"
        backendRequest: "25s"
      retry:
        numRetries: 3
        retryOn:
          - server-error
          - gateway-error
          - connect-failure
        backoff:
          baseInterval: "100ms"
          maxInterval: "10s"

    # Rule 2: Route /api/v2/* to backend-v2 with canary deployment
    - matches:
        - path:
            type: PathPrefix
            value: "/api/v2"
      backendRefs:
        - name: backend-v2-stable
          port: 8080
          weight: 90
        - name: backend-v2-canary
          port: 8080
          weight: 10

    # Rule 3: Redirect HTTP to HTTPS
    - matches:
        - path:
            type: PathPrefix
            value: "/"
          headers:
            - name: X-Forwarded-Proto
              value: "http"
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301

    # Rule 4: URL rewrite example
    - matches:
        - path:
            type: PathPrefix
            value: "/legacy"
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: "/api/v1"
      backendRefs:
        - name: backend-v1
          port: 8080

    # Rule 5: Direct response for health check
    - matches:
        - path:
            type: Exact
            value: "/healthz"
      filters:
        - type: DirectResponse
          directResponse:
            statusCode: 200
            body:
              type: Inline
              inline: '{"status": "healthy"}'
